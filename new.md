```
# 基于知识驱动规则优化与分层推理的频谱分析仪故障诊断方法

本文介绍了一种基于知识驱动的分层推理架构应用于频谱分析仪故障诊断的模型。此方法结合了BRB（信念规则库）和特征-模块映射策略，通过优化规则库和推理流程来提高诊断准确性，并实现规则压缩和特征分流。

## 目录

1. [项目结构](#项目结构)
2. [方法概述](#方法概述)
3. [特征增强与分流](#特征增强与分流)
4. [推理优化与规则压缩](#推理优化与规则压缩)
5. [归一化与阈值策略](#归一化与阈值策略)
6. [对比方法与实验](#对比方法与实验)
7. [实验结果](#实验结果)

## 项目结构
```

project/
 ├── baseline/                # RRS 构建 + 包络提取
 ├── features/                # 系统级 & 模块级特征提取
 ├── BRB/                     # BRB 推理相关（系统层 + 模块层）
 ├── methods/                 # 其他对比方法封装目录
 │    ├── ours/              # 本文提出方法
 │    ├── brb_mu/
 │    ├── dbrb/
 │    ├── aifd/
 │    ├── a_ibrb/
 │    └── brb_p/
 ├── pipelines/               # 实验脚本 & 流水线
 │    ├── run_baseline.py
 │    ├── simulate/
 │    ├── detect.py
 │    └── compare_methods.py
 ├── comparison/              # 结果分析 & 可视化
 ├── data/                    # 输入数据
 └── Output/                  # 运行输出结果

```
## 方法概述

### **本文方法：基于知识驱动的分层推理架构**

本方法结合了知识驱动的特征-模块映射与两层BRB推理架构。系统级特征用于刻画频谱分析仪整体幅频特性与频率标度异常，模块级特征仅从与对应功能模块物理相关的频段与信号特性中提取。系统级BRB首先输出异常类型概率分布，结果作为先验信息用于激活模块级BRB，仅对可能受影响的模块子集执行推理，从而实现规则压缩。

### **对比方法**

我们采用以下五种现代BRB变体作为对比：

1. **BRB-MU**（多源不确定信息，可信诊断）
2. **DBRB**（深层BRB，解决规则爆炸问题）
3. **AIFD**（自适应 + 可解释性）
4. **A-IBRB**（自动化Interval-BRB）
5. **BRB-P**（BRB + 概率表 + 解释性约束）

## 特征增强与分流

### **系统级特征**

- X1：整体幅度偏移
- X2：带内平坦度指标
- X3：高频段衰减斜率
- X4：频率标度非线性度
- X5：幅度缩放一致性
- X6：纹波
- X7：增益非线性
- X8：本振泄漏
- X9：调谐线性度残差
- X10：不同频段幅度一致性

### **模块级特征**

- X11：增益失真度
- X12：电源噪声
- X13：信号幅度变化率
- X14：频段响应精度
- X15：相位偏差

### **特征增强**

1. 使用**动态包络分析**（如Hilbert变换）来增强特征。
2. 利用**频率对齐**和**曲线形变**特征（例如，`X16_corr_shift_bins`等）。

### **特征分流**

1. **系统层特征分流**：将特征按幅度类、频率类和参考电平类分流。
2. **模块层特征分流**：根据不同模块的功能，仅激活相关的特征子集。

## 推理优化与规则压缩

### **系统级推理**

通过分流和多级BRB推理，减少冗余计算。系统级推理模块拆分为三个子BRB（针对幅度、频率、参考电平类异常）：

- `BRB/system_brb_amp.py`：用于幅度异常的推理。
- `BRB/system_brb_freq.py`：用于频率异常的推理。
- `BRB/system_brb_ref.py`：用于参考电平异常的推理。

通过`softmax`进行概率校准（使用温度调节，alpha=2.0）来提高推理的鲁棒性。

### **模块级推理**

每个模块仅使用与其功能相关的特征，并执行规则压缩。通过控制系统级推理结果，仅激活相关模块的推理，从而实现有效的规则压缩。

### **模块激活与规则压缩**

1. **系统级推理**：只传递相关特征给模块层进行推理。
2. **模块层规则压缩**：通过物理链路优化模块规则，使得规则数目减少。

## 归一化与阈值策略

### **特征归一化**

1. **robust z-score归一化**：使用中位数（median）和四分位差（IQR）进行标准化：
   \[
   \text{normalized\_value} = \frac{x - \text{median}}{\text{IQR} + \epsilon}
   \]
   该方法抗噪声，并且对于极端值不太敏感。

2. **分位数归一化**：将特征值映射到[0, 1]范围内：
   \[
   \text{normalized\_value} = \frac{x - \text{min}(x)}{\text{max}(x) - \text{min}(x)}
   \]

### **阈值策略**

1. **正常状态识别**：通过**overall_score**（通过X11~X13等特征得到）来判断当前的频谱分析仪是否处于“正常”状态。
2. **max_prob阈值**：在推理过程中，当最大概率`max_prob`小于某个阈值（如0.3），则判定为正常状态。
3. **softmax温度调整**：通过调整`alpha`（通常设为2.0）来控制softmax的温度，抑制过度自信的推理结果。

## 对比方法与实验

### **实验目标**
为了验证本方法的有效性，我们对比了以下几种现代BRB方法：
1. **BRB-MU**：多源不确定信息 + 可信诊断
2. **DBRB**：深层BRB，解决规则爆炸
3. **AIFD**：自适应 + 可解释性
4. **A-IBRB**：自动化Interval-BRB
5. **BRB-P**：BRB + 概率表 + 解释性约束

### **评估指标**
- **系统级**：准确率、宏平均F1、混淆矩阵
- **模块级**：Top-1/Top-3准确率
- **推理效率**：单样本推理时间
- **模型复杂度**：规则数量 + 参数数量

### **实验流程**
1. 运行 `run_baseline.py` 生成基线。
2. 使用 `simulate/run_simulation_brb.py` 生成仿真数据。
3. 运行 `compare_methods.py` 对比所有方法。
4. 输出结果：`comparison_table.csv`, `performance_table.csv`, `confusion_system.png`, `confusion_module.png`.

## 实验结果

实验将详细列出各方法的准确率、推理效率、模型复杂度等指标，并通过混淆矩阵可视化对比结果。

---

## 总结

本文方法通过结合知识驱动规则优化与分层推理架构，实现了频谱分析仪故障诊断的高效推理和高准确率。与其他BRB变体相比，本方法不仅能够减少规则爆炸，还能显著提高推理效率，尤其在小样本情况下展现了较好的鲁棒性。

---

### **架构调整确认**

1. **现有代码架构已具备**：
   - 特征分流和模块激活逻辑已经在`system_brb.py`和`module_brb.py`中实现。如果这些部分运行良好，可以保留当前架构，无需进一步拆分为独立文件。
   
2. **是否需要架构重构**：
   - 如果当前的测试准确率已经达到了预期，可以继续保持现有架构。若需要进一步优化性能，拆分为独立的文件和模块是一个可选步骤，但不一定强制实施。

---

### **运行命令**

1. **生成基线**：  
   ```bash
   python pipelines/run_baseline.py
```

1. **生成仿真数据**：

   ```
   python pipelines/simulate/run_simulation_brb.py
   ```

2. **运行对比实验**：

   ```
   python pipelines/compare_methods.py
   ```

3. **查看结果**：

   - `Output/comparison_table.csv`：方法 vs 各指标
   - `Output/performance_table.csv`：详细结果
   - `Output/confusion_system.png`：系统级混淆矩阵
   - `Output/confusion_module.png`：模块级混淆矩阵

------

这样，**完整的`README.md`文件**已经为您准备好，涵盖了方法描述、实验流程、结果输出等各个部分，希望能帮助你更好地组织项目和展示方法。如果有任何进一步的修改或需求，请随时告知！