#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
共享配置模块 (Shared Configuration)
====================================
集中定义特征参数、模块分组和归一化参数，避免代码重复。

本模块包含：
1. 系统级和模块级特征定义与归一化参数
2. 模块分组与特征映射规则
3. BRB推理的超参数配置
"""

from __future__ import annotations

from typing import Dict, List, Tuple

# ============================================================================
# 特征定义
# ============================================================================

# 系统级特征 (X1-X10)
SYSTEM_FEATURE_NAMES = {
    'X1': '整体幅度偏移',
    'X2': '带内平坦度指标',
    'X3': '高频段衰减斜率',
    'X4': '频率标度非线性度',
    'X5': '幅度缩放一致性',
    'X6': '纹波',
    'X7': '增益非线性',
    'X8': '本振泄漏',
    'X9': '调谐线性度残差',
    'X10': '不同频段幅度一致性',
}

# 模块级特征 (X11-X15)
MODULE_FEATURE_NAMES = {
    'X11': '包络超出率',
    'X12': '最大包络违规幅度',
    'X13': '包络违规能量',
    'X14': '低频段残差均值',
    'X15': '高频段残差标准差',
}

# 频率对齐特征 (X16-X18)
FREQUENCY_FEATURE_NAMES = {
    'X16': '互相关滞后/频移',
    'X17': '频轴缩放因子',
    'X18': '频轴平移因子',
}

# 幅度细粒度特征 (X19-X22)
AMPLITUDE_DETAIL_FEATURE_NAMES = {
    'X19': '低频段斜率',
    'X20': '去趋势残差峰度',
    'X21': '残差峰值数量',
    'X22': '残差主频能量占比',
}

# ============================================================================
# 特征归一化参数 (统一配置)
# ============================================================================

# 格式: (lower, upper) - 用于线性归一化到 [0, 1]
FEATURE_NORM_PARAMS: Dict[str, Tuple[float, float]] = {
    # 系统级基础特征 (X1-X5)
    'X1': (0.02, 0.5),       # 整体幅度偏移
    'X2': (0.002, 0.05),     # 带内平坦度
    'X3': (1e-11, 1e-9),     # 高频段衰减斜率 (修正为更合理范围)
    'X4': (5e5, 3e7),        # 频率标度非线性度
    'X5': (0.01, 0.35),      # 幅度缩放一致性
    
    # 模块级症状特征 (X6-X10)
    'X6': (0.001, 0.03),     # 纹波方差
    'X7': (0.05, 2.0),       # 增益非线性
    'X8': (0.01, 1.0),       # 本振泄漏
    'X9': (1e3, 1e5),        # 调谐线性度残差
    'X10': (0.02, 0.5),      # 频段幅度一致性
    
    # 包络/残差特征 (X11-X15)
    'X11': (0.01, 0.3),      # 包络超出率
    'X12': (0.5, 5.0),       # 最大包络违规
    'X13': (0.1, 10.0),      # 包络违规能量
    'X14': (0.01, 1.0),      # 低频段残差均值
    'X15': (0.01, 0.5),      # 高频段残差标准差
    
    # 频率对齐特征 (X16-X18)
    'X16': (0.001, 0.1),     # 频移
    'X17': (0.001, 0.05),    # 频率缩放
    'X18': (0.001, 0.05),    # 频率平移
    
    # 幅度细粒度特征 (X19-X22)
    'X19': (1e-11, 1e-9),    # 低频段斜率 (修正为更合理范围)
    'X20': (0.5, 5.0),       # 去趋势残差峰度
    'X21': (1, 20),          # 残差峰值数量
    'X22': (0.1, 0.8),       # 残差主频能量占比
}

# ============================================================================
# 特征权重配置
# ============================================================================

# 幅度异常相关特征权重
AMP_FEATURE_WEIGHTS: Dict[str, float] = {
    'X1': 0.20,   # 整体幅度偏移 - 最重要
    'X2': 0.15,   # 带内平坦度
    'X5': 0.12,   # 幅度缩放一致性
    'X6': 0.08,   # 纹波
    'X7': 0.10,   # 增益非线性
    'X10': 0.08,  # 频段幅度一致性
    'X11': 0.06,  # 包络超出率
    'X12': 0.05,  # 最大包络违规
    'X13': 0.05,  # 包络违规能量
    'X19': 0.03,  # 低频段斜率
    'X20': 0.03,  # 去趋势残差峰度
    'X21': 0.02,  # 残差峰值数
    'X22': 0.03,  # 残差主频能量占比
}

# 频率异常相关特征权重
FREQ_FEATURE_WEIGHTS: Dict[str, float] = {
    'X4': 0.20,   # 频率标度非线性 - 最重要
    'X8': 0.10,   # 本振泄漏
    'X9': 0.10,   # 调谐线性度残差
    'X14': 0.10,  # 低频段残差
    'X15': 0.10,  # 高频段残差
    'X16': 0.15,  # 频移 - 重要
    'X17': 0.15,  # 频率缩放
    'X18': 0.10,  # 频率平移
}

# 参考电平异常相关特征权重
REF_FEATURE_WEIGHTS: Dict[str, float] = {
    'X1': 0.25,   # 整体幅度偏移 - 最重要
    'X3': 0.15,   # 高频段衰减斜率
    'X5': 0.15,   # 幅度缩放一致性
    'X10': 0.10,  # 频段幅度一致性
    'X11': 0.15,  # 包络超出率
    'X12': 0.10,  # 最大包络违规
    'X13': 0.10,  # 包络违规能量
}

# 整体异常度计算权重
OVERALL_SCORE_WEIGHTS: Dict[str, float] = {
    'X1': 0.15, 'X2': 0.12, 'X3': 0.08, 'X4': 0.10, 'X5': 0.10,
    'X6': 0.05, 'X7': 0.08, 'X8': 0.05, 'X9': 0.03, 'X10': 0.04,
    'X11': 0.08, 'X12': 0.05, 'X13': 0.05, 'X14': 0.02, 'X15': 0.02,
    'X16': 0.03, 'X17': 0.02, 'X18': 0.02,
    'X19': 0.02, 'X20': 0.02, 'X21': 0.01, 'X22': 0.01,
}

# ============================================================================
# 特征分流规则
# ============================================================================

# 系统级异常类型特征分流
SYSTEM_BRANCH_FEATURES: Dict[str, List[str]] = {
    # 幅度失准相关特征
    'amp': ['X1', 'X2', 'X5', 'X6', 'X7', 'X10', 'X11', 'X12', 'X13', 'X19', 'X20', 'X21', 'X22'],
    # 频率失准相关特征  
    'freq': ['X4', 'X8', 'X9', 'X14', 'X15', 'X16', 'X17', 'X18'],
    # 参考电平失准相关特征
    'ref': ['X1', 'X3', 'X5', 'X10', 'X11', 'X12', 'X13'],
}

# 故障类型名称映射
FAULT_TYPE_MAPPING: Dict[str, str] = {
    '幅度失准': 'amp',
    '频率失准': 'freq', 
    '参考电平失准': 'ref',
    'amp': 'amp',
    'freq': 'freq',
    'ref': 'ref',
    'amplitude': 'amp',
    'frequency': 'freq',
    'reference': 'ref',
}

# ============================================================================
# 模块分组配置
# ============================================================================

MODULE_LABELS: List[str] = [
    "衰减器",
    "前置放大器",
    "低频段前置低通滤波器",
    "低频段第一混频器",
    "高频段YTF滤波器",
    "高频段混频器",
    "时钟振荡器",
    "时钟合成与同步网络",
    "本振源（谐波发生器）",
    "本振混频组件",
    "校准源",
    "存储器",
    "校准信号开关",
    "中频放大器",
    "ADC",
    "数字RBW",
    "数字放大器",
    "数字检波器",
    "VBW滤波器",
    "电源模块",
]

# 模块分组 - 按物理链路和功能相关性
MODULE_GROUPS: Dict[str, List[str]] = {
    # 幅度链路模块组
    'amp_group': [
        '衰减器', '前置放大器', '中频放大器', '数字放大器', 'ADC',
        '数字RBW', '数字检波器', 'VBW滤波器'
    ],
    # 频率链路模块组
    'freq_group': [
        '时钟振荡器', '时钟合成与同步网络', '本振源（谐波发生器）', '本振混频组件',
        '高频段YTF滤波器', '高频段混频器', '低频段前置低通滤波器', '低频段第一混频器'
    ],
    # 参考电平链路模块组
    'ref_group': [
        '校准源', '存储器', '校准信号开关', '衰减器'
    ],
    # 通用模块
    'other_group': [
        '电源模块'
    ],
}

# 模块特征映射
MODULE_FEATURES_BY_GROUP: Dict[str, List[str]] = {
    'amp_group': ['X1', 'X2', 'X5', 'X6', 'X7', 'X10', 'X11', 'X12', 'X13', 'X19', 'X20', 'X21', 'X22'],
    'freq_group': ['X4', 'X8', 'X9', 'X14', 'X15', 'X16', 'X17', 'X18'],
    'ref_group': ['X1', 'X3', 'X5', 'X10', 'X11', 'X12', 'X13'],
    'other_group': ['X1', 'X2', 'X3', 'X4', 'X5', 'X6', 'X7', 'X8', 'X9', 'X10'],
}

# 异常类型到模块组的映射
FAULT_TYPE_TO_MODULE_GROUP: Dict[str, str] = {
    'amp': 'amp_group',
    'freq': 'freq_group',
    'ref': 'ref_group',
    '幅度失准': 'amp_group',
    '频率失准': 'freq_group',
    '参考电平失准': 'ref_group',
}

# ============================================================================
# BRB推理超参数
# ============================================================================

# 默认softmax温度
DEFAULT_ALPHA: float = 2.0

# 整体异常度阈值
DEFAULT_OVERALL_THRESHOLD: float = 0.15

# 最大概率阈值
DEFAULT_MAX_PROB_THRESHOLD: float = 0.3

# 三角隶属度参数
MEMBERSHIP_LOW: float = 0.15
MEMBERSHIP_CENTER: float = 0.35
MEMBERSHIP_HIGH: float = 0.7

# ============================================================================
# 归一化统计参数 (用于robust z-score归一化)
# ============================================================================

DEFAULT_NORMALIZATION_STATS: Dict[str, Dict[str, float]] = {
    # 系统级基础特征 (X1-X5)
    'X1': {'median': 0.0, 'q25': -0.1, 'q75': 0.1, 'min': -0.5, 'max': 0.5},
    'X2': {'median': 0.005, 'q25': 0.002, 'q75': 0.01, 'min': 0.0, 'max': 0.05},
    'X3': {'median': 0.0, 'q25': -1e-10, 'q75': 1e-10, 'min': -1e-9, 'max': 1e-9},
    'X4': {'median': 0.05, 'q25': 0.02, 'q75': 0.1, 'min': 0.0, 'max': 0.5},
    'X5': {'median': 0.1, 'q25': 0.05, 'q75': 0.2, 'min': 0.0, 'max': 0.35},
    
    # 模块级症状特征 (X6-X10)
    'X6': {'median': 0.005, 'q25': 0.002, 'q75': 0.01, 'min': 0.0, 'max': 0.03},
    'X7': {'median': 0.2, 'q25': 0.1, 'q75': 0.5, 'min': 0.0, 'max': 2.0},
    'X8': {'median': 0.1, 'q25': 0.05, 'q75': 0.2, 'min': 0.0, 'max': 1.0},
    'X9': {'median': 1e4, 'q25': 5e3, 'q75': 2e4, 'min': 0.0, 'max': 1e5},
    'X10': {'median': 0.1, 'q25': 0.05, 'q75': 0.2, 'min': 0.0, 'max': 0.5},
    
    # 包络/残差特征 (X11-X15)
    'X11': {'median': 0.05, 'q25': 0.02, 'q75': 0.1, 'min': 0.0, 'max': 0.3},
    'X12': {'median': 1.0, 'q25': 0.5, 'q75': 2.0, 'min': 0.0, 'max': 5.0},
    'X13': {'median': 1.0, 'q25': 0.5, 'q75': 3.0, 'min': 0.0, 'max': 10.0},
    'X14': {'median': 0.1, 'q25': 0.05, 'q75': 0.3, 'min': 0.0, 'max': 1.0},
    'X15': {'median': 0.1, 'q25': 0.05, 'q75': 0.2, 'min': 0.0, 'max': 0.5},
    
    # 频率对齐特征 (X16-X18)
    'X16': {'median': 0.0, 'q25': -0.01, 'q75': 0.01, 'min': -0.1, 'max': 0.1},
    'X17': {'median': 0.0, 'q25': -0.01, 'q75': 0.01, 'min': -0.05, 'max': 0.05},
    'X18': {'median': 0.0, 'q25': -0.01, 'q75': 0.01, 'min': -0.05, 'max': 0.05},
    
    # 幅度细粒度特征 (X19-X22)
    'X19': {'median': 0.0, 'q25': -1e-10, 'q75': 1e-10, 'min': -1e-9, 'max': 1e-9},
    'X20': {'median': 1.0, 'q25': 0.5, 'q75': 2.0, 'min': 0.0, 'max': 5.0},
    'X21': {'median': 5, 'q25': 2, 'q75': 10, 'min': 0, 'max': 20},
    'X22': {'median': 0.3, 'q25': 0.15, 'q75': 0.5, 'min': 0.0, 'max': 0.8},
}
